name: Upgrade requirements

on:
  repository_dispatch:
    types: [trigger-workflow]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Extract branch name
        id: extract_branch
        run: |
          branch_ref="${{ github.event.client_payload.branch }}"
          if [[ $branch_ref == refs/heads/* ]]; then
            branch_name=${branch_ref#refs/heads/}
          else
            branch_name=${branch_ref}
          fi
          echo "branch_name=${branch_name}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.extract_branch.outputs.branch_name || 'main' }}

      # Update Dockerfile line
      - name: Update Dockerfile
        run: |
          lib_name=${{ github.event.client_payload.lib_name }}
          lib_vers=${{ github.event.client_payload.lib_vers }}
          sed -E -i "s/ver_${lib_name}=.+/ver_${lib_name}=${lib_vers}/1" ./Dockerfile/Dockerfile-handler-3-9
          sed -E -i "s/ver_${lib_name}=.+/ver_${lib_name}=${lib_vers}/1" ./Dockerfile/Dockerfile-handler-3-10
          sed -E -i "s/ver_${lib_name}=.+/ver_${lib_name}=${lib_vers}/1" ./Dockerfile/Dockerfile-handler-3-11

      # Commit modifications to Dockerfile
      - name: Commit changes
        run: |
          lib_name=${{ github.event.client_payload.lib_name }}
          lib_vers=${{ github.event.client_payload.lib_vers }}
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git commit -a -m "bump: bumpver ${lib_name} to ${lib_vers}"
          git push
